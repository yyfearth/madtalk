// Generated by eXtraCoffeeScript 1.2.0r
(function() {
"use strict"
  var Login, add_log, channel, do_login, login, user, xss_safe, _log;

  /* imported /Users/wilson/Dev/madtalk/public/class/Login.coffee
  */


  Login = (function() {

    Login.name = 'Login';

    function Login(cfg) {
      var _el, _ref;
      this.cfg = cfg != null ? cfg : {
        el: '#login'
      };
      this.user = ((_ref = this.cfg.user) != null ? _ref.nick : void 0) ? this.cfg.user : null;
      if (typeof this.cfg.logined === 'function') this.logined = this.cfg.logined;
      /* private
      */

      _el = null;
      /* public
      */

      Object.defineProperties(this, {
        el: {
          get: function() {
            return _el;
          },
          set: function(value) {
            _el = value;
            if (typeof _el === 'string') return _el = document.querySelector(_el);
          }
        },
        inited: {
          get: function() {
            return _el != null;
          }
        },
        hidden: {
          get: function() {
            return _el.hidden;
          }
        }
      });
    }

    /* public methods
    */


    Login.prototype.init = function() {
      var _ref, _ref2,
        _this = this;
      if (this.inited) return;
      console.log('init');
      if (this.cfg.el) this.el = this.cfg.el;
      this.show(!((_ref = this.user) != null ? _ref.nick : void 0));
      this.form = this.el.querySelector('form');
      this.form.onsubmit = function(e) {
        e.preventDefault();
        _this.user = {
          nick: _this.form.nick.value
        };
        _this.show(false);
        if (typeof _this.logined === "function") _this.logined(_this.user);
        return false;
      };
      if ((_ref2 = this.user) != null ? _ref2.nick : void 0) {
        if (typeof this.logined === "function") this.logined(this.user);
      }
      return this;
    };

    Login.prototype.show = function(show) {
      if (show == null) show = true;
      console.log('show', show, this.el);
      this.el.hidden = !show;
      return this;
    };

    Login.prototype.hide = function() {
      return this.show(false);
    };

    return Login;

  })();

  channel = io.connect('/0');

  try {
    user = sessionStorage.user;
    if (user) {
      user = JSON.parse(user);
      if (!(user != null ? user.nick : void 0)) throw 'bad user session data';
    } else {
      user = null;
    }
  } catch (e) {
    console.error('bad user session data', e);
    user = null;
  }

  xss_safe = {
    replace_regex: /<|>/g,
    replace_dict: {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#x27;',
      '/': '&#x2F;'
    },
    esc_regex: /\\[\/\\nbtvfr'"0(u\w{4})(x\w{2})]/g,
    esc_dict: {
      '\\': '\\',
      '\/': '\/',
      '"': '"',
      "'": "'",
      '0': '\x0',
      'n': '\n',
      'b': '\b',
      't': '\t',
      'v': '\v',
      'f': '\f',
      'r': '\r'
    },
    url: function(url) {
      return encodeURI(url);
    },
    attr: function(str) {
      return str.toString().replace(/\W/g, function(ch) {
        var s;
        s = ch.charCodeAt(0);
        return ch = s < 255 ? "&#" + s + ";" : ch;
      });
    },
    js: function(str, noesc) {
      var _this = this;
      if (!noesc) {
        str = str.replace(this.esc_regex, function(ch) {
          ch = ch.slice(1);
          if (_this.esc_dict[ch] != null) {
            return _this.esc_dict[ch];
          } else {
            return String.fromCharCode(Number(ch.clice(1)));
          }
        });
      }
      return str.replace(/\W/g, function(ch) {
        var s;
        s = ch.charCodeAt(0);
        if (s < 255) {
          s = s.toString(16);
          if (s.length < 2) s = '0' + s;
          return '\\x' + s;
        } else {
          return ch;
        }
      });
    },
    str: function(str) {
      var _this = this;
      return str.toString().replace(this.replace_regex, function(p) {
        return _this.replace_dict[p];
      });
    },
    json: function(json, parse) {
      var is_str;
      is_str = typeof json === 'string';
      if (!is_str) json = JSON.stringify(json);
      json = this.str(json);
      if (is_str || !parse) {
        return json;
      } else {
        return JSON.parse(json);
      }
    }
  };

  _log = null;

  add_log = function(recs) {
    if (!Array.isArray(recs)) recs = [recs];
    recs = recs.map(function(rec) {
      return "<li>" + (xss_safe.str(rec.user.nick)) + " - " + (new Date(rec.ts).toLocaleTimeString()) + "<br/>" + (xss_safe.str(rec.data).replace(/\n/g, '<br/>')) + "</li>";
    });
    _log.append(recs.join('\n'));
  };

  do_login = function(user) {
    console.log('do_login', user);
    channel.emit('login', user, function(upduser, records) {
      if (upduser.err) {
        return console.error(upduser);
      } else {
        console.log('logined', upduser);
        user.uid = upduser.uid;
        channel.el = document.querySelector('#channel');
        channel.el.hidden = false;
        channel.on('online', function(user) {
          console.log('online', user);
          return _log.append("<li>" + user.nick + " Online</li>");
        });
        channel.on('offline', function(user) {
          console.log('offline', user);
          return _log.append("<li>" + user.nick + " Offline</li>");
        });
        channel.on('message', function(data) {
          console.log('got message', data);
          return add_log(data);
        });
        channel.message = function(data) {
          return channel.emit('message', data, function(ok) {
            if (ok) {
              return console.log('message sent', data);
            } else {
              return console.error(data);
            }
          });
        };
        window.onbeforeunload = function() {
          sessionStorage.user = JSON.stringify(user);
          return 'sure to exit?';
        };
        $('#entry').keydown(function(e) {
          if (e.keyCode === 13 && !(e.ctrlKey || e.metaKey || e.shiftKey || e.altKey)) {
            channel.message({
              type: 'text',
              data: this.value
            });
            this.value = '';
            return false;
          }
        });
        _log.empty();
        add_log(records);
      }
    });
  };

  login = new Login({
    el: '#login',
    user: user,
    logined: do_login
  });

  window.channel = channel;

  channel.on('connect', function() {
    console.log('connected');
    return $(function() {
      console.log('domready');
      $('#conn-status').text('online');
      _log = $('#log');
      channel.on('system', function(data) {
        return console.log('got system message', data);
      });
      if (!login.inited) return login.init();
    });
  });

  channel.on('disconnect', function() {
    return $('#conn-status').text('offline');
  });

}).call(this);

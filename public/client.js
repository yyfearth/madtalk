// Generated by eXtraCoffeeScript 1.2.0l
(function() {
  var channel, user;

  channel = io.connect('/0');

  try {
    user = sessionStorage.user;
    if (user) user = JSON.parse(user);
    if (!(user != null ? user.nick : void 0)) throw 'bad user session data';
  } catch (e) {
    console.error('bad user session data', e);
    user = {
      nick: prompt('nickname:')
    };
  }

  channel.on('connect', function() {
    console.log('connected');
    return channel.emit('login', user, function(newuser) {
      if (newuser.err) {
        return console.error(newuser);
      } else {
        console.log('logined', newuser);
        user.uid = newuser.uid;
        channel.on('online', function(user) {
          return console.log('online', user);
        });
        channel.on('offline', function(user) {
          return console.log('offline', user);
        });
        channel.on('message', function(data) {
          return console.log('got message', data);
        });
        return channel.message = function(data) {
          return channel.emit('message', data, function(ok) {
            if (ok) {
              return console.log('message sent', data);
            } else {
              return console.error(data);
            }
          });
        };
      }
    });
  });

  window.channel = channel;

  window.onbeforeunload = function() {
    sessionStorage.user = JSON.stringify(user);
    return 'sure to exit?';
  };

  $(function() {});

}).call(this);
